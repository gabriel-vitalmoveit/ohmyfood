name: Deploy Flutter Web Apps (cPanel via FTP)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-flutter-apps-main
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      stamp: ${{ steps.meta.outputs.stamp }}
    steps:
      - name: Compute tag + timestamp
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          STAMP="$(date -u +%Y%m%d-%H%M%S)"
          echo "stamp=$STAMP" >> "$GITHUB_OUTPUT"
          echo "tag=web-build-$STAMP" >> "$GITHUB_OUTPUT"

  build-and-deploy:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      # GitHub Actions currently rejects `secrets.*` in `if:` expressions at workflow validation time.
      # Work around by mapping secrets -> env, and using env.* in `if:`.
      # Prefer direct cPanel hostname if secret still points to legacy ftp hostname.
      FTP_SERVER: ${{ (secrets.FTP_SERVER == 'ftp.ohmyfood.com' && 'sxb1plzcpnl505625.prod.sxb1.secureserver.net') || secrets.FTP_SERVER || secrets.CPANEL_FTP_SERVER || 'sxb1plzcpnl505625.prod.sxb1.secureserver.net' }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME || secrets.CPANEL_FTP_USERNAME || '' }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD || secrets.CPANEL_FTP_PASSWORD || '' }}
      FTP_PORT: ${{ secrets.FTP_PORT || secrets.CPANEL_FTP_PORT || '' }}
      FTP_PROTOCOL: ${{ secrets.FTP_PROTOCOL || '' }}
      FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR || '' }}
      FTP_COURIER_DIR: ${{ secrets.FTP_COURIER_DIR || '' }}
      FTP_RESTAURANT_DIR: ${{ secrets.FTP_RESTAURANT_DIR || '' }}
      FTP_CUSTOMER_DIR: ${{ secrets.FTP_CUSTOMER_DIR || '' }}
      FTP_ADMIN_DIR: ${{ secrets.FTP_ADMIN_DIR || '' }}
      # Disable FTP by default (shared hosting often blocks port 21).
      # Enable explicitly by setting secret ENABLE_FTP_DEPLOY=true.
      ENABLE_FTP_DEPLOY: ${{ secrets.ENABLE_FTP_DEPLOY || '' }}
    strategy:
      fail-fast: false
      # GoDaddy/cPanel FTP accounts often have low concurrent session limits.
      # Run matrix sequentially to avoid intermittent 530 auth failures.
      max-parallel: 1
      matrix:
        app:
          - name: courier
            path: apps/courier_app
            dest: public_html/estafeta.ohmyfood.eu/
            zip_prefix: estafeta.ohmyfood.eu
            needs_here: true
          - name: restaurant
            path: apps/restaurant_app
            dest: public_html/restaurante.ohmyfood.eu/
            zip_prefix: restaurante.ohmyfood.eu
            needs_here: false
          - name: customer
            path: apps/customer_app
            # Main domain docroot is usually just public_html/
            dest: public_html/ohmyfood.eu/
            zip_prefix: ohmyfood.eu
            needs_here: false
          - name: admin
            path: apps/admin_panel
            # Admin subdomain docroot (cPanel): public_html/admin.ohmyfood.eu/
            # You can override via secret FTP_ADMIN_DIR if your docroot differs.
            dest: public_html/admin.ohmyfood.eu/
            zip_prefix: admin.ohmyfood.eu
            needs_here: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mark workspace as safe for git
        shell: bash
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.24.0"
          cache: true

      - name: Dependencies (shared packages)
        shell: bash
        run: |
          set -euo pipefail
          (cd packages/design_system && flutter pub get)
          (cd packages/shared_models && flutter pub get)

      - name: Dependencies (app)
        working-directory: ${{ matrix.app.path }}
        run: flutter pub get

      - name: Build web (release)
        working-directory: ${{ matrix.app.path }}
        env:
          BUILD_ENV: ${{ secrets.ENV || 'prod' }}
          API_BASE_URL: ${{ secrets.API_BASE_URL || secrets.COURIER_API_BASE_URL }}
          HERE_MAPS_API_KEY: ${{ secrets.HERE_MAPS_API_KEY || '' }}
          NEEDS_HERE: ${{ matrix.app.needs_here }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "$API_BASE_URL" ]]; then
            echo "Missing secret: API_BASE_URL" >&2
            exit 1
          fi

          if [[ "$NEEDS_HERE" == "true" && -z "$HERE_MAPS_API_KEY" ]]; then
            echo "WARN: HERE_MAPS_API_KEY empty; courier app will run with fallback." >&2
          fi

          flutter build web --release \
            --dart-define=ENV="$BUILD_ENV" \
            --dart-define=API_BASE_URL="$API_BASE_URL" \
            --dart-define=HERE_MAPS_API_KEY="$HERE_MAPS_API_KEY"

      - name: Ensure .htaccess (SPA routing)
        shell: bash
        run: |
          set -euo pipefail
          target="${{ matrix.app.path }}/build/web/.htaccess"
          printf '%s\n' \
            '<IfModule mod_rewrite.c>' \
            '  RewriteEngine On' \
            '  RewriteBase /' \
            '  RewriteRule ^index\.html$ - [L]' \
            '  RewriteCond %{REQUEST_FILENAME} !-f' \
            '  RewriteCond %{REQUEST_FILENAME} !-d' \
            '  RewriteRule . /index.html [L]' \
            '</IfModule>' \
            '' \
            '<IfModule mod_expires.c>' \
            '  ExpiresActive On' \
            '  ExpiresByType text/css "access plus 1 year"' \
            '  ExpiresByType application/javascript "access plus 1 year"' \
            '  ExpiresByType image/png "access plus 1 year"' \
            '  ExpiresByType image/jpg "access plus 1 year"' \
            '  ExpiresByType image/jpeg "access plus 1 year"' \
            '  ExpiresByType image/gif "access plus 1 year"' \
            '  ExpiresByType image/svg+xml "access plus 1 year"' \
            '</IfModule>' \
            > "$target"

      - name: Write deploy marker
        env:
          APP_NAME: ${{ matrix.app.name }}
          SHA: ${{ github.sha }}
          STAMP: ${{ needs.prepare.outputs.stamp }}
        shell: bash
        run: |
          set -euo pipefail
          out="${{ matrix.app.path }}/build/web/deploy_marker.txt"
          printf "app=%s\nsha=%s\ntimestamp=%s\n" "$APP_NAME" "$SHA" "$STAMP" > "$out"

      - name: Zip build output (with .htaccess)
        env:
          STAMP: ${{ needs.prepare.outputs.stamp }}
          ZIP_PREFIX: ${{ matrix.app.zip_prefix }}
        shell: bash
        run: |
          set -euo pipefail
          BUILD_DIR="${{ matrix.app.path }}/build/web"
          if [[ ! -d "$BUILD_DIR" ]]; then
            echo "Missing build output directory: $BUILD_DIR" >&2
            exit 1
          fi
          ZIP_DIR="${GITHUB_WORKSPACE}/dist/zips"
          mkdir -p "$ZIP_DIR"
          ZIP_PATH="${ZIP_DIR}/${ZIP_PREFIX}_web_${STAMP}.zip"

          # Use absolute output path to avoid relative-path issues from build/web.
          (cd "$BUILD_DIR" && zip -r "$ZIP_PATH" .)

          echo "Built ZIP: $ZIP_PATH"
          ls -lh "$ZIP_PATH"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app.name }}-web-zip-${{ needs.prepare.outputs.tag }}
          path: dist/zips/*.zip
          if-no-files-found: error

      - name: Resolve FTP server-dir
        id: resolve_server_dir
        shell: bash
        env:
          APP_NAME: ${{ matrix.app.name }}
          DEFAULT_DIR: ${{ matrix.app.dest }}
          FTP_SERVER_DIR: ${{ env.FTP_SERVER_DIR }}
          FTP_COURIER_DIR: ${{ env.FTP_COURIER_DIR }}
          FTP_RESTAURANT_DIR: ${{ env.FTP_RESTAURANT_DIR }}
          FTP_CUSTOMER_DIR: ${{ env.FTP_CUSTOMER_DIR }}
          FTP_ADMIN_DIR: ${{ env.FTP_ADMIN_DIR }}
        run: |
          set -euo pipefail

          raw="$DEFAULT_DIR"
          case "$APP_NAME" in
            courier)
              raw="${FTP_COURIER_DIR:-${FTP_SERVER_DIR:-$DEFAULT_DIR}}"
              ;;
            restaurant)
              raw="${FTP_RESTAURANT_DIR:-$DEFAULT_DIR}"
              ;;
            customer)
              raw="${FTP_CUSTOMER_DIR:-$DEFAULT_DIR}"
              ;;
            admin)
              raw="${FTP_ADMIN_DIR:-$DEFAULT_DIR}"
              ;;
          esac

          # Normalize: trim whitespace + ensure trailing slash.
          server_dir="$(printf '%s' "$raw" | xargs)"
          if [[ -z "$server_dir" ]]; then
            echo "Resolved server-dir is empty (APP_NAME=$APP_NAME)" >&2
            exit 1
          fi
          # cPanel FTP paths are typically relative (no leading slash).
          # If the secret was configured as "/public_html/...", strip the leading slash.
          server_dir="${server_dir#/}"
          # Basic safety checks: no traversal and no empty after normalization.
          if [[ "$server_dir" == *".."* ]]; then
            echo "Resolved server-dir contains '..' (APP_NAME=$APP_NAME, server_dir=$server_dir)" >&2
            exit 1
          fi
          [[ "$server_dir" != */ ]] && server_dir="$server_dir/"

          echo "server_dir=$server_dir" >> "$GITHUB_OUTPUT"
          echo "server_dir_len=${#server_dir}" >> "$GITHUB_OUTPUT"
          echo "Resolved server-dir (len=${#server_dir}) for $APP_NAME"

      - name: Deploy to cPanel via FTP
        if: ${{ env.ENABLE_FTP_DEPLOY == 'true' && env.FTP_SERVER != '' && env.FTP_USERNAME != '' && env.FTP_PASSWORD != '' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          # GoDaddy cPanel typically requires explicit FTPS on port 21.
          # Override with secret FTP_PROTOCOL if needed: ftp | ftps | ftps-legacy
          protocol: ${{ env.FTP_PROTOCOL || 'ftps' }}
          server: ${{ env.FTP_SERVER }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          port: ${{ env.FTP_PORT || 21 }}
          local-dir: ${{ matrix.app.path }}/build/web/
          server-dir: ${{ steps.resolve_server_dir.outputs.server_dir }}
          # Avoid stale assets by replacing server-dir completely.
          dangerous-clean-slate: true
          state-name: .ftp-deploy-state-${{ matrix.app.name }}.json
          timeout: 300000
          log-level: verbose

      - name: FTP disabled notice (use Release deploy script)
        if: ${{ env.ENABLE_FTP_DEPLOY != 'true' }}
        shell: bash
        run: |
          echo "FTP deploy is disabled (ENABLE_FTP_DEPLOY != 'true')."
          echo "This workflow will publish GitHub Release ZIPs."
          echo "Deploy on cPanel using scripts/cpanel_deploy_from_release.php (manual or cron/webhook)."

  release:
    needs: [prepare, build-and-deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CPANEL_DEPLOY_WEBHOOK_URL: ${{ secrets.CPANEL_DEPLOY_WEBHOOK_URL || '' }}
      CPANEL_DEPLOY_WEBHOOK_TOKEN: ${{ secrets.CPANEL_DEPLOY_WEBHOOK_TOKEN || '' }}
    steps:
      - name: Download all ZIP artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release-assets
          pattern: "*-web-zip-${{ needs.prepare.outputs.tag }}"
          merge-multiple: true

      - name: Create GitHub Release + upload ZIPs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Web build ${{ needs.prepare.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/release-assets/**/*.zip

      - name: Comment on commit with Release link
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.prepare.outputs.tag }}
          SHA: ${{ github.sha }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          url="https://github.com/$REPO/releases/tag/$TAG"
          gh api "repos/$REPO/commits/$SHA/comments" -f body="✅ Web build disponível: $url"

      - name: Trigger cPanel deploy webhook (optional)
        if: ${{ env.CPANEL_DEPLOY_WEBHOOK_URL != '' && env.CPANEL_DEPLOY_WEBHOOK_TOKEN != '' }}
        env:
          WEBHOOK_URL: ${{ env.CPANEL_DEPLOY_WEBHOOK_URL }}
          WEBHOOK_TOKEN: ${{ env.CPANEL_DEPLOY_WEBHOOK_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS -X POST \
            -H "X-Deploy-Token: $WEBHOOK_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{\"tag\":\"$TAG\"}" \
            "$WEBHOOK_URL"

