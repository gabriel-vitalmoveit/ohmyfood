name: Rebuild Flutter Web Apps (Release ZIPs)

on:
  workflow_dispatch: {}

concurrency:
  group: web-build-main
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      stamp: ${{ steps.meta.outputs.stamp }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute tag + timestamp
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          STAMP="$(date -u +%Y%m%d-%H%M%S)"
          echo "stamp=$STAMP" >> "$GITHUB_OUTPUT"
          echo "tag=web-build-$STAMP" >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: courier
            app_dir: apps/courier_app
            zip_prefix: estafeta.ohmyfood.eu
            needs_here: true
          - id: restaurant
            app_dir: apps/restaurant_app
            zip_prefix: restaurante.ohmyfood.eu
            needs_here: false
          - id: customer
            app_dir: apps/customer_app
            zip_prefix: ohmyfood.eu
            needs_here: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Pub get (shared packages)
        shell: bash
        run: |
          set -euo pipefail
          (cd packages/design_system && flutter pub get)
          (cd packages/shared_models && flutter pub get)

      - name: Pub get (app)
        working-directory: ${{ matrix.app_dir }}
        run: flutter pub get

      - name: Build Flutter web (release)
        working-directory: ${{ matrix.app_dir }}
        env:
          BUILD_ENV: ${{ secrets.ENV || 'prod' }}
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          HERE_MAPS_API_KEY: ${{ secrets.HERE_MAPS_API_KEY || '' }}
          NEEDS_HERE: ${{ matrix.needs_here }}
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "$API_BASE_URL" ]]; then
            echo "Missing secret: API_BASE_URL" >&2
            exit 1
          fi

          if [[ "$NEEDS_HERE" == "true" && -z "$HERE_MAPS_API_KEY" ]]; then
            echo "WARN: HERE_MAPS_API_KEY empty; courier app will run with fallback." >&2
          fi

          flutter build web --release \
            --dart-define=ENV="$BUILD_ENV" \
            --dart-define=API_BASE_URL="$API_BASE_URL" \
            --dart-define=HERE_MAPS_API_KEY="$HERE_MAPS_API_KEY"

      - name: Add .htaccess (SPA routing) + zip build output
        env:
          STAMP: ${{ needs.prepare.outputs.stamp }}
          ZIP_PREFIX: ${{ matrix.zip_prefix }}
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="${{ matrix.app_dir }}"
          BUILD_DIR="$APP_DIR/build/web"

          if [[ ! -d "$BUILD_DIR" ]]; then
            echo "Missing build output directory: $BUILD_DIR" >&2
            exit 1
          fi

          STAGE_DIR="dist/web/$ZIP_PREFIX"
          ZIP_PATH="dist/zips/${ZIP_PREFIX}_web_${STAMP}.zip"

          rm -rf "$STAGE_DIR"
          mkdir -p "$STAGE_DIR" "dist/zips"
          cp -R "$BUILD_DIR/"* "$STAGE_DIR/"

          cat > "$STAGE_DIR/.htaccess" <<'EOF'
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
</IfModule>
EOF

          (cd "$STAGE_DIR" && zip -r "../../zips/$(basename "$ZIP_PATH")" . >/dev/null)

          echo "Built ZIP: $ZIP_PATH"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.id }}-web-zip-${{ needs.prepare.outputs.tag }}
          path: dist/zips/*.zip
          if-no-files-found: error

  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all ZIP artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release-assets
          pattern: "*-web-zip-${{ needs.prepare.outputs.tag }}"
          merge-multiple: true

      - name: Create GitHub Release + upload ZIPs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Web build ${{ needs.prepare.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/release-assets/**/*.zip

      - name: Comment on commit with Release link
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.prepare.outputs.tag }}
          SHA: ${{ github.sha }}
          REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          url="https://github.com/$REPO/releases/tag/$TAG"
          gh api "repos/$REPO/commits/$SHA/comments" -f body="✅ Web build disponível: $url"

