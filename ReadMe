<div align="center">
  <img src="docs/assets/logo.png" alt="OhMyFood" width="240" />
  <h1>OhMyFood ‚Äì Plataforma Portuguesa de Entrega On-Demand</h1>
  <p><em>Substitua <code>docs/assets/logo.png</code> pelo logo oficial fornecido.</em></p>
</div>

## üß≠ Vis√£o Geral

OhMyFood √© um MVP+ para uma plataforma de entregas on-demand focada no mercado portugu√™s, com piloto em Lisboa e escalabilidade para todo o territ√≥rio nacional e ilhas. O monorepo cont√©m quatro aplica√ß√µes Flutter (Cliente, Estafeta, Restaurante e Admin Web), um backend NestJS com Prisma/PostgreSQL, integra√ß√µes com Stripe, Mapbox, Redis para realtime/filas e infraestrutura local via Docker Compose.

## üì¶ Estrutura do Monorepo

```
apps/
  customer_app/
  courier_app/
  restaurant_app/
  admin_panel/
packages/
  design_system/
  shared_models/
backend/
  api/
infra/
  docker-compose.yml
scripts/
  bootstrap_flutter.sh
melos.yaml
.env.example
ReadMe (este ficheiro)
```

## üöÄ Aplica√ß√µes Flutter

- `customer_app`: onboarding, cat√°logo, carrinho, pagamentos, tracking e chat.
- `courier_app`: onboarding, aceitar pedidos, navega√ß√£o e ganhos.
- `restaurant_app`: gest√£o de menu, aceita√ß√£o e m√©tricas b√°sicas.
- `admin_panel`: live ops, campanhas, utilizadores, auditoria.

Cada app partilha o `design_system` e `shared_models`. Para orquestrar pacotes foi configurado `melos` com scripts utilit√°rios.

### Bootstrap das apps

```bash
./scripts/bootstrap_flutter.sh
```

> Pr√©-requisitos: Flutter 3.19+, Dart 3.3+, fvm opcional. O script instala depend√™ncias (`flutter pub get`) em todas as apps e pacotes.

### Executar cada app

```bash
cd apps/customer_app && flutter run -d chrome
cd apps/courier_app && flutter run -d chrome
cd apps/restaurant_app && flutter run -d chrome
cd apps/admin_panel && flutter run -d chrome
```

Substitua `-d chrome` por `-d android` ou `-d ios` conforme o alvo.

## üß∞ Backend NestJS

### Stack

- NestJS 10 + TypeScript
- Prisma ORM + PostgreSQL
- WebSockets (Socket.IO) para chat/tracking
- Stripe (pagamentos) e Mapbox (geocoding/ETA)
- Redis (cache, filas e estado temps)

### M√≥dulos Principais

- `auth`: registo/login com JWT (access + refresh), hashing Argon2.
- `users`: perfis e consultas.
- `restaurants`: listagem, cat√°logo, hor√°rios.
- `menu`: itens, varia√ß√µes e addons.
- `orders`: cria√ß√£o, estados e liga√ß√£o a pagamentos.
- `dispatch`: matching inicial de estafetas (placeholder com log e filtro de estafetas online).
- `payments`: intents Stripe, webhooks e reconcilia√ß√£o.
- `promos`: promo√ß√µes ativas.
- `chat`: gateway WebSocket `/chat` com persist√™ncia.
- `admin`: dashboards e live ops b√°sicos.

### Configura√ß√£o Local

1. **Clonar vari√°veis de ambiente**

   ```bash
   cp .env.example backend/api/.env
   ```

   Ajuste credenciais (Stripe, Mapbox, MB WAY/Multibanco futuro, buckets, etc.).

2. **Infraestrutura**

   ```bash
   cd infra
   docker compose up -d
   ```

   Servi√ßos levantados: PostgreSQL (`5432`), Redis (`6379`), Adminer (`8080`).

3. **Backend API**

   ```bash
   cd backend/api
   npm install
   npx prisma migrate dev
   npm run db:seed
   npm run start:dev
   ```

   - Swagger dispon√≠vel em `http://localhost:3000/docs`.
   - Seed cria utilizadores demo (admin, restaurante) e exemplo de menu.

4. **Prisma Studio (opcional)**

   ```bash
   npx prisma studio
   ```

### Stripe

- Defina `STRIPE_API_KEY` e `STRIPE_WEBHOOK_SECRET` no `.env`.
- Webhook dispon√≠vel em `POST /payments/stripe/webhook` (configurar endpoint local com `stripe listen`).
- Placeholder cria `PaymentIntent` via `StripeIntegrationService` e regista pagamento na base.

### Mapbox

- Configurar `MAPBOX_API_KEY`.
- `MapboxService` exp√µe `geocode` para utiliza√ß√£o em m√≥dulos de dispatch ou onboarding.
- Futuro: c√°lculo de rotas, ETA e heatmaps.

### Redis & Realtime

- Redis previsto para filas de dispatch, cache de localiza√ß√£o, rate-limiting.
- Chat usa Socket.IO (`/chat`) e FCM (a configurar nas apps) para push notifications.

### Seguran√ßa

- JWT (15m access / 7d refresh) com rota√ß√£o manual no futuro.
- Helmet/CORS/rate-limit devem ser adicionados via middleware (ver sec√ß√£o TODO).
- RBAC com pap√©is (`Role` enum) e valida√ß√£o nas rotas planeada.

## üóÇÔ∏è Modelo de Dados (Prisma)

Modelos principais: `User`, `Restaurant`, `MenuItem`, `OptionGroup`, `Option`, `Order`, `OrderItem`, `Payment`, `Promo`, `PromoRedemption`, `Chat`, `Message`, `Courier`, `CourierLocation`.

Estados de pedido (`OrderStatus`): `DRAFT ‚Üí AWAITING_ACCEPTANCE ‚Üí PREPARING ‚Üí PICKUP ‚Üí ON_THE_WAY ‚Üí DELIVERED`. Cancelamentos e auditoria previstos.

## üîÑ Fluxos Cr√≠ticos (MVP)

- **Checkout & Pagamento**: Cria√ß√£o de pedido ‚Üí PaymentIntent Stripe ‚Üí webhook confirma ‚Üí estado avan√ßa para `AWAITING_ACCEPTANCE`.
- **Dispatch**: Servi√ßo `DispatchService` faz matching inicial (placeholder com `findEligibleCouriers`). Pr√≥ximos passos incluem timers, ondas e fallback.
- **Chat/Tracking**: Gateway WebSocket + estrutura Messenger. Necess√°rio integrar FCM para notifica√ß√µes push.

## ‚úÖ Crit√©rios de Pronto (Piloto Lisboa)

- 50‚Äì100 restaurantes onboard.
- 50‚Äì200 estafetas validados.
- Pagamentos cart√£o + MB WAY, tracking est√°vel, chat funcional.
- Admin panel com live ops e campanhas.
- SLA < 35‚Äì45 min.

## üõ£Ô∏è Roadmap (8 semanas)

1. **Sprint 1 ‚Äì Funda√ß√µes**
   - Monorepo, skeletons Flutter, design system.
   - Backend: Auth, Users, Restaurants, Swagger, seeds.
   - Config placeholders Mapbox/Stripe.
2. **Sprint 2 ‚Äì Pedidos Core**
   - Menu, carrinho, c√°lculo de taxas.
   - Cria√ß√£o de pedido + intents.
   - Webhooks pagamento + aceita√ß√£o restaurante.
   - Admin MVP (listagens).
3. **Sprint 3 ‚Äì Dispatch & Realtime**
   - Matching estafetas (ondas/timers).
   - Tracking WebSocket + FCM.
   - Chat por pedido, ratings, relat√≥rios restaurante.
4. **Sprint 4 ‚Äì Portugal Ready**
   - MB WAY/Multibanco.
   - RGPD (export/delete), hardening seguran√ßa.
   - Performance pass, builds release Android/iOS/Web.

## üß™ Testes & Qualidade

- Backend: adicionar Jest + `@nestjs/testing` (n√£o inclu√≠do por brevidade).
- Flutter: widget tests para flows cr√≠ticos (checkout, tracking, chat).
- CI/CD: configurar GitHub Actions (lint/test/build/deploy) com Railway/Fly.io.

## üì∏ Logo

Guarde o logo fornecido em `docs/assets/logo.png` para refer√™ncia partilhada no monorepo. Atualize as apps Flutter para o utilizar no onboarding e home.

## üîí RGPD & Seguran√ßa

- Consentimentos e gest√£o de dados (export/delete) prontos para Sprint 4.
- Logs de auditoria (`Order.auditLog`, `Order.statusHistory`).
- Vari√°veis sens√≠veis em `.env` e gest√£o via secret manager em produ√ß√£o.
- Backups autom√°ticos do Postgres (cron Railway/Fly.io) sugeridos.

## üîó Integra√ß√µes Futuras

- **MB WAY/Multibanco**: Add provider na camada `payments`, webhooks unificados.
- **Ifthenpay/EuPago/SIBS**: adaptadores via `payments/providers/*` (estrutura sugerida).
- **FCM**: tokens armazenados por utilizador, refresh via backend.
- **Mapas**: geofencing e throttling no app Estafeta (5‚Äì10s).

## üß≠ Pr√≥ximos Passos Imediatos

1. Implementar UI real nas apps Flutter consumindo endpoints (`/restaurants`, `/orders`, `/promos`).
2. Conectar app Cliente ao fluxo de checkout completo (Stripe + webhook ‚Üí estado `AWAITING_ACCEPTANCE`).
3. Evoluir Admin Panel com dashboards em tempo real (socket + mapas).
4. Solidificar m√≥dulo Dispatch com l√≥gica baseada em dist√¢ncia e SLA.

---

Made with ‚ù§Ô∏è para acelerar o lan√ßamento do OhMyFood em Portugal.
